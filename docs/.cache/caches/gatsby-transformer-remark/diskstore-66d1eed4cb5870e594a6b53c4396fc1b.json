{"expireTime":9007200819376323000,"key":"transformer-remark-markdown-html-ast-dc378c56e9b49e1af052415f00facc75-gatsby-remark-autolink-headersgatsby-remark-copy-linked-filesgatsby-remark-prismjsgatsby-remark-check-links-","val":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"GraphQL offers a number of interesting insights in the realm of server performance and usage monitoring. Because the structure of GraphQL queries requires clients to request exactly the fields they need, simple instrumentation allows us to elicit exactly which fields in the schema are being used at any given time. This helps us understand how much usage different parts of our data model get at a far more granular level than we could achieve out of the box with non-GraphQL APIs."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"tracing-query-execution"},"children":[{"type":"element","tagName":"a","properties":{"href":"#tracing-query-execution","aria-label":"tracing query execution permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"Tracing query execution"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A \"trace\" corresponds to exactly one "},{"type":"element","tagName":"a","properties":{"href":"https://www.warthog.dev/docs/resources/graphql-glossary.html#operation"},"children":[{"type":"text","value":"GraphQL operation"}]},{"type":"text","value":" and represents a breakdown of timing and error information for each individual field resolved as part of that operation."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"By recording which resolvers executed in our server and their traces, we can build a rich dataset. From it, we see exactly which query shapes are being run, who is sending them, which parts of the schema are most utilized, which resolvers in the server are bottlenecks, etc."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We've specifically built an interface to view this information into "},{"type":"element","tagName":"a","properties":{"href":"https://engine.warthog.dev/"},"children":[{"type":"text","value":"Warthog Engine"}]},{"type":"text","value":" and any GraphQL server can report metrics to Engine by sending data in the "},{"type":"raw","value":"<code class=\"language-text\">warthog-tracing</code>"},{"type":"text","value":" format to our metrics ingress. Read on to learn how to set this up in your environment."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"warthog-server"},"children":[{"type":"element","tagName":"a","properties":{"href":"#warthog-server","aria-label":"warthog server permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"Warthog Server"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Warthog Server has had the ability to report its performance usage metrics to Engine built-in. To set it up, get an API key from "},{"type":"element","tagName":"a","properties":{"href":"https://engine.warthog.dev/"},"children":[{"type":"text","value":"Engine"}]},{"type":"text","value":" by logging in and creating a graph. Then set your API key in the "},{"type":"raw","value":"<code class=\"language-text\">ENGINE_API_KEY</code>"},{"type":"text","value":" environment variable or pass it into your Warthog Server constructor like so:"}]},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> ApolloServer <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"warthog-server\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  typeDefs<span class=\"token punctuation\">,</span>\n  resolvers<span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">  engine<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    apiKey<span class=\"token punctuation\">:</span> <span class=\"token string\">'YOUR API KEY HERE'</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nserver<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> url <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">ðŸš€  Server ready at </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>url<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"For advanced configuration options to set up logging, error filtering, and client-aware metrics reporting take a look at our "},{"type":"element","tagName":"a","properties":{"href":"https://www.warthog.dev/docs/warthog-server/features/metrics.html"},"children":[{"type":"text","value":"server documentation"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"other-servers"},"children":[{"type":"element","tagName":"a","properties":{"href":"#other-servers","aria-label":"other servers permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"Other servers"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"There are 2 ways to send metrics data from your server to Engine:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Report traces directly from your server to our reporting endpoint"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Use an Warthog tracing package and the Engine proxy (deprecated)"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"engine-reporting-endpoint"},"children":[{"type":"element","tagName":"a","properties":{"href":"#engine-reporting-endpoint","aria-label":"engine reporting endpoint permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"Engine reporting endpoint"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We recommend following the agent pattern to report trace metrics from your server to the Engine reporting endpoint. This is what Warthog Server does internally and you can view the code for the "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/goldcaddy77/warthog-server/blob/3d6912434051ae7038153ef39e32f485a35609f0/packages/warthog-engine-reporting/src/agent.ts"},"children":[{"type":"text","value":"Warthog Server reference agent"}]},{"type":"text","value":" as an example."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We've been working with our community to build agent integrations for non-JavaScript servers. If you're interested in collaborating with us on an integration for your server, please get in touch with us at "},{"type":"element","tagName":"a","properties":{"href":"mailto:support@warthog.dev"},"children":[{"type":"text","value":"support@warthog.dev"}]},{"type":"text","value":" or via our "},{"type":"element","tagName":"a","properties":{"href":"https://spectrum.chat/warthog"},"children":[{"type":"text","value":"Warthog Spectrum Community"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"There are four steps to creating a reporting agent for any server:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Translating execution information into the correct Tracing format"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Implementing a default signature function to identify operations"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Emitting batches of Traces to the reporting endpoint"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Providing plugins for more advanced reporting functionality"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"1-tracing-format"},"children":[{"type":"element","tagName":"a","properties":{"href":"#1-tracing-format","aria-label":"1 tracing format permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"1. Tracing Format"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The first step of creating a metrics reporting agent will be to hook into the GraphQL execution pipeline to create the metrics and translate them into the proper data format."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The reporting endpoint accepts a batch of \"traces\" encoded as protobuf. Each individual trace represents execution of a single operation, specifically timing and error information of that execution, broken down by field. Each trace also contains context that is operation-specific (e.g. which client an operation was sent from, if the response was fetched from the cache). In addition to the batch of trace details, the metrics report also includes the context within which all operations were executed (e.g. staging vs prod) in a report header."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"As mentioned, this batch of traces and context is encoded via protobuf. The schema for the protobuf message is defined as the "},{"type":"raw","value":"<code class=\"language-text\">FullTracesReport</code>"},{"type":"text","value":" message in the "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/goldcaddy77/warthog-server/blob/master/packages/warthog-engine-reporting-protobuf/src/reports.proto#L380"},"children":[{"type":"text","value":"TypeScript reference implementation"}]},{"type":"text","value":". The reporting agent is "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"not"}]},{"type":"text","value":" responsible for aggregating this list of individual traces and filtering out certain traces to persist. That process is handled via Warthog's cloud services."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"As a good starting point, we recommend implementing an extension to the GraphQL execution that creates a report with one trace, as defined in the "},{"type":"raw","value":"<code class=\"language-text\">Trace</code>"},{"type":"text","value":" message of "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/goldcaddy77/warthog-server/blob/master/packages/warthog-engine-reporting-protobuf/src/reports.proto#L9"},"children":[{"type":"text","value":"the protobuf schema"}]},{"type":"text","value":". The next step will be to batch multiple traces into a single report, which we recommend batches of 5-10 seconds while limiting reports to a reasonable size (~4MB)."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Many server runtimes already have support for emitting tracing information as a "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/goldcaddy77/warthog-tracing"},"children":[{"type":"text","value":"GraphQL extension"}]},{"type":"text","value":", which involves hooking into the request pipeline and capturing timing and error data about each resolver's execution. These implementations include runtimes in "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/goldcaddy77/warthog-server/blob/master/packages/warthog-engine-reporting/src/extension.ts"},"children":[{"type":"text","value":"Node"}]},{"type":"text","value":", "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/uniiverse/warthog-tracing-ruby"},"children":[{"type":"text","value":"Ruby"}]},{"type":"text","value":", "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/sangria-graphql/sangria-slowlog#warthog-tracing-extension"},"children":[{"type":"text","value":"Scala"}]},{"type":"text","value":", "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/graphql-java/graphql-java/pull/577"},"children":[{"type":"text","value":"Java"}]},{"type":"text","value":", "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/sikanhe/warthog-tracing-elixir"},"children":[{"type":"text","value":"Elixir"}]},{"type":"text","value":", and "},{"type":"element","tagName":"a","properties":{"href":"https://graphql-dotnet.github.io/docs/getting-started/metrics/"},"children":[{"type":"text","value":".NET"}]},{"type":"text","value":". If you're working on adding metrics reporting functionality for one of "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"these languages"}]},{"type":"text","value":", reading through that tracing instrumentation is a good place to start and to plug into. For "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"other languages"}]},{"type":"text","value":", we recommend reading through the "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/goldcaddy77/warthog-server/blob/master/packages/warthog-engine-reporting/src/extension.ts"},"children":[{"type":"text","value":"Warthog Server instrumentation"}]},{"type":"text","value":" as reference."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"An example of a FullTracesReport message, represented as JSON, can be found below"},{"type":"text","value":"*"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"2-operation-signing"},"children":[{"type":"element","tagName":"a","properties":{"href":"#2-operation-signing","aria-label":"2 operation signing permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"2. Operation Signing"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In order to correctly group GraphQL operations, it's important to define a method for \"signing\" a query. Because GraphQL queries can be expressed in a variety of ways, this is a harder problem than it may\nappear to be at first thought. For instance, even though all of the following queries request the same\ninformation, it's ambiguous whether they should be treated equally."}]},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-graphql line-numbers\"><code class=\"language-graphql\"><span class=\"token keyword\">query</span> AuthorForPost<span class=\"token punctuation\">(</span><span class=\"token variable\">$foo</span><span class=\"token punctuation\">:</span> String<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  post<span class=\"token punctuation\">(</span><span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token variable\">$foo</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    author\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">query</span> AuthorForPost<span class=\"token punctuation\">(</span><span class=\"token variable\">$bar</span><span class=\"token punctuation\">:</span> String<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  post<span class=\"token punctuation\">(</span><span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token variable\">$bar</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    author\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">query</span> AuthorForPost<span class=\"token punctuation\">(</span><span class=\"token variable\">$foo</span><span class=\"token punctuation\">:</span> String<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  post<span class=\"token punctuation\">(</span><span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token variable\">$foo</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    author\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">query</span> AuthorForPost <span class=\"token punctuation\">{</span>\n  post<span class=\"token punctuation\">(</span><span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"my-post-id\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    author\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">query</span> AuthorForPost <span class=\"token punctuation\">{</span>\n  post<span class=\"token punctuation\">(</span><span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"my-post-id\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token attr-name\">writer</span><span class=\"token punctuation\">:</span> author\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Even though this concept lacks definition, it's important to decide on how queries should be grouped together when tracking metrics about GraphQL execution. The concept of a "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"\"query signature\""}]},{"type":"text","value":" is what we use at Warthog to group similar operations together even if their exact textual representations are not identical. The query signature, along with the operation name, are used to group queries together in the "},{"type":"raw","value":"<code class=\"language-text\">FullTracesReport</code>"},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The TypeScript reference implementation uses a default signature method and allows for that signature method to also be overridden by the user. The "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/goldcaddy77/warthog-server/blob/master/packages/warthog-engine-reporting/src/signature.ts"},"children":[{"type":"text","value":"implementation of the default"}]},{"type":"text","value":" drops unused fragments and/or operations, hides String literals, ignores aliases, sorts the tree deterministically, and ignores whitespace differences. We recommend using the same default signature method for consistency across different server runtimes."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"3-sending-metrics"},"children":[{"type":"element","tagName":"a","properties":{"href":"#3-sending-metrics","aria-label":"3 sending metrics permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"3. Sending Metrics"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Once a metrics report (i.e. batch of traces) is prepared, it will need to be sent to an ingress for aggregation and sampling. Currently, this is all performed in Warthog's cloud services. The endpoint for this aggregation and sampling is at "},{"type":"raw","value":"<code class=\"language-text\">https://engine-report.apollodata.com/api/ingress/traces</code>"},{"type":"text","value":", which supports the protobuf format mentioned above via a "},{"type":"raw","value":"<code class=\"language-text\">POST</code>"},{"type":"text","value":" request. The reporting endpoint accepts a gzipped body as well. To see the full reference implementation, see the "},{"type":"raw","value":"<code class=\"language-text\">sendReport()</code>"},{"type":"text","value":" method in the "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/goldcaddy77/warthog-server/blob/master/packages/warthog-engine-reporting/src/agent.ts#L210"},"children":[{"type":"text","value":"TypeScript reference agent"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Reporting agents can authenticate either via the "},{"type":"raw","value":"<code class=\"language-text\">X-Api-Key</code>"},{"type":"text","value":" header or the "},{"type":"raw","value":"<code class=\"language-text\">authtoken</code>"},{"type":"text","value":" cookie with the service API key."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We recommend implementing retries with backoff on 5xx responses and network errors and allowing for the batching size to be tunable by the user. Additionally, we recommend adding a shutdown hook to send all pending reports to ensure that healthy server shutdowns do not result in missing data, as this tracing information is especially important."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"NOTE: In the future, we plan to release a local aggregation and sampling agent that could be used to lessen the bandwidth requirements on reporting agents."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"4-optional-advanced-reporting-features"},"children":[{"type":"element","tagName":"a","properties":{"href":"#4-optional-advanced-reporting-features","aria-label":"4 optional advanced reporting features permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"4. "},{"type":"text","value":"[Optional]"},{"type":"text","value":" Advanced Reporting Features"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The reference TypeScript implementation also includes several more advanced features which may be worth porting to new implementations. All of these features are implemented in the agent itself and are documented in the interface description for the EngineReportingOptions of "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/goldcaddy77/warthog-server/blob/master/packages/warthog-engine-reporting/src/agent.ts#L51"},"children":[{"type":"text","value":"the agent"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"For example, the option to send reports immediately may be particularly useful to GraphQL servers running in a serverless environment, like AWS Lambda or Google Cloud Functions."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Another important feature is the ability to limit information sent, particularly to avoid reporting "},{"type":"element","tagName":"a","properties":{"href":"https://en.wikipedia.org/wiki/Personal_data"},"children":[{"type":"text","value":"personal data"}]},{"type":"text","value":". Because the most common place for personal data to appear is in variables and headers, the TypeScript agent offers options for "},{"type":"raw","value":"<code class=\"language-text\">privateVariables</code>"},{"type":"text","value":" and "},{"type":"raw","value":"<code class=\"language-text\">privateHeaders</code>"},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"example-fulltracesreport-represented-as-json"},"children":[{"type":"element","tagName":"a","properties":{"href":"#example-fulltracesreport-represented-as-json","aria-label":"example fulltracesreport represented as json permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"Example FullTracesReport, represented as JSON"}]},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"json\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-json line-numbers\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"header\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"hostname\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"www.example.com\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"schemaTag\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"staging\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"schemaHash\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"alskncka384u1923e8uino1289jncvo019n\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"tracesPerQuery\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"# Foo\\nquery Foo { user { email } }\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"trace\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"endTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2018-11-25T18:28:36.604Z\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"startTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2018-11-25T18:28:36.104Z\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"clientName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"c1\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"clientVersion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"v1\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"http\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"method\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"POST\"</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"durationNs\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2498055950907169\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"root\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"fieldName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"User!\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"startTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"endTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"10\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"child\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n              <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"fieldName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"email\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"String!\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"startTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"11\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"endTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"12\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"parentType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"User\"</span>\n              <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"parentType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Query\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"endTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2018-11-25T18:28:37.004Z\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"startTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2018-11-25T18:28:36.404Z\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"clientName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"c2\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"clientVersion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"v1\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"http\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"method\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"POST\"</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"durationNs\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"13154220\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"root\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"fieldName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"User!\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"startTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"endTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"10\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"child\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n              <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"fieldName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"email\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"String!\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"startTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"13\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"endTime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"15\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"parentType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"User\"</span>\n              <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"parentType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Query\"</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"clientReferenceId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"c2_id\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":198,"column":1,"offset":12230}}}}