{"expireTime":9007200819376316000,"key":"transformer-remark-markdown-html-ast-a92442bb2f11ba467eaa8a03b28df92c-gatsby-remark-autolink-headersgatsby-remark-copy-linked-filesgatsby-remark-prismjsgatsby-remark-check-links-","val":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A common challenge that developers experience as they build products is how quickly their apps grow in complexity. For GraphQL services, your request sizes and query strings fatten over time, which in turn leads to extra weight transferred over the network."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This guide details some practices around enhancing network performance which will help bring data closer to your clients."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"automatic-persisted-queries"},"children":[{"type":"element","tagName":"a","properties":{"href":"#automatic-persisted-queries","aria-label":"automatic persisted queries permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"Automatic Persisted Queries"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The size of individual GraphQL query strings can be a major pain point. Warthog Server implements Automatic Persisted Queriesâ€Š(APQ), a technique that greatly improves network performance for GraphQL with zero build-time configuration. A persisted query is a ID or hash that can be sent to the server instead of the entire GraphQL query string. This smaller signature reduces bandwidth utilization and speeds up client loading times. Persisted queries are especially nice paired with GET requests, enabling the browser cache and "},{"type":"element","tagName":"a","properties":{"href":"#cdn-integration"},"children":[{"type":"text","value":"integration with a CDN"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"With Warthog Persisted Queries, the ID is a deterministic hash of the input query, so we don't need a complex build step to share the ID between clients and servers. If a server doesn't know about a given hash, the client can expand the query for it; Warthog Server caches that mapping."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"setup"},"children":[{"type":"element","tagName":"a","properties":{"href":"#setup","aria-label":"setup permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"Setup"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To get started with APQ, add the "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/goldcaddy77/warthog-link-persisted-queries"},"children":[{"type":"text","value":"Automatic Persisted Queries Link"}]},{"type":"text","value":" to the client codebase with "},{"type":"raw","value":"<code class=\"language-text\">npm install warthog-link-persisted-queries</code>"},{"type":"text","value":". Next incorporate the APQ link with Warthog Client's link chain before the HTTP link:"}]},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createPersistedQueryLink <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"warthog-link-persisted-queries\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createHttpLink <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"warthog-link-http\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> InMemoryCache <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"warthog-cache-inmemory\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> ApolloClient <span class=\"token keyword\">from</span> <span class=\"token string\">\"warthog-client\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> link <span class=\"token operator\">=</span> <span class=\"token function\">createPersistedQueryLink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token function\">createHttpLink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> uri<span class=\"token punctuation\">:</span> <span class=\"token string\">\"/graphql\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  cache<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InMemoryCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  link<span class=\"token punctuation\">:</span> link<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Note: Users of "},{"type":"raw","value":"<code class=\"language-text\">warthog-boost</code>"},{"type":"text","value":" must "},{"type":"element","tagName":"a","properties":{"href":"https://www.warthog.dev/docs/react/advanced/boost-migration.html"},"children":[{"type":"text","value":"migrate to "},{"type":"raw","value":"<code class=\"language-text\">warthog-client</code>"}]},{"type":"text","value":" in order to use the "},{"type":"raw","value":"<code class=\"language-text\">warthog-link-persisted-queries</code>"},{"type":"text","value":" package."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Inside Warthog Server, the query registry is stored in a user-configurable cache. By default, Warthog Server uses a in-memory cache. This can be configured inside of the "},{"type":"raw","value":"<code class=\"language-text\">ApolloServer</code>"},{"type":"text","value":" constructor:"}]},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> MemcachedCache <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'warthog-server-memcached'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> ApolloServer <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'warthog-server'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  typeDefs<span class=\"token punctuation\">,</span>\n  resolvers<span class=\"token punctuation\">,</span>\n  persistedQueries<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    cache<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MemcachedCache</span><span class=\"token punctuation\">(</span>\n      <span class=\"token punctuation\">[</span><span class=\"token string\">'memcached-server-1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'memcached-server-2'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'memcached-server-3'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> retries<span class=\"token punctuation\">:</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> retry<span class=\"token punctuation\">:</span> <span class=\"token number\">10000</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Options</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"verify"},"children":[{"type":"element","tagName":"a","properties":{"href":"#verify","aria-label":"verify permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"Verify"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Warthog Server's persisted queries configuration can be tested from the command-line. The following examples assume Warthog Server is running at "},{"type":"raw","value":"<code class=\"language-text\">localhost:4000/</code>"},{"type":"text","value":".\nThis example persists a dummy query of "},{"type":"raw","value":"<code class=\"language-text\">{__typename}</code>"},{"type":"text","value":", using its sha256 hash: "},{"type":"raw","value":"<code class=\"language-text\">ecf4edb46db40b5132295c0291d62fb65d6759a9eedfa4d5d612dd5ec54a6b38</code>"},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Request a persisted query:"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">curl</span> -g <span class=\"token string\">'http://localhost:4000/?extensions={\"persistedQuery\":{\"version\":1,\"sha256Hash\":\"ecf4edb46db40b5132295c0291d62fb65d6759a9eedfa4d5d612dd5ec54a6b38\"}}'</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>"},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"   Expect a response of: "},{"type":"raw","value":"<code class=\"language-text\">{&quot;errors&quot;: [{&quot;message&quot;: &quot;PersistedQueryNotFound&quot;, &quot;extensions&quot;: {...}}]}</code>"},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{"start":2},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Store the query to the cache:"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">curl</span> -g <span class=\"token string\">'http://localhost:4000/?query={__typename}&amp;extensions={\"persistedQuery\":{\"version\":1,\"sha256Hash\":\"ecf4edb46db40b5132295c0291d62fb65d6759a9eedfa4d5d612dd5ec54a6b38\"}}'</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>"},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"   Expect a response of "},{"type":"raw","value":"<code class=\"language-text\">{&quot;data&quot;: {&quot;__typename&quot;: &quot;Query&quot;}}&quot;</code>"},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{"start":3},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"Request the persisted query again:"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">curl</span> -g <span class=\"token string\">'http://localhost:4000/?extensions={\"persistedQuery\":{\"version\":1,\"sha256Hash\":\"ecf4edb46db40b5132295c0291d62fb65d6759a9eedfa4d5d612dd5ec54a6b38\"}}'</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>"},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"   Expect a response of "},{"type":"raw","value":"<code class=\"language-text\">{&quot;data&quot;: {&quot;__typename&quot;: &quot;Query&quot;}}&quot;</code>"},{"type":"text","value":", as the query string is loaded from the cache."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"using-get-requests-with-apq-to-enable-cdns"},"children":[{"type":"element","tagName":"a","properties":{"href":"#using-get-requests-with-apq-to-enable-cdns","aria-label":"using get requests with apq to enable cdns permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"Using GET requests with APQ to enable CDNs"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A great application for APQ is running Warthog Server behind a CDN. Many CDNs only cache GET requests, but many GraphQL queries are too long to fit comfortably in a cacheable GET request.  When the APQ link is created with "},{"type":"raw","value":"<code class=\"language-text\">createPersistedQueryLink({useGETForHashedQueries: true})</code>"},{"type":"text","value":", Warthog Client automatically sends the short hashed queries as GET requests allowing a CDN to serve those request. For full-length queries and for all mutations, Warthog Client will continue to use POST requests."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"how-it-works"},"children":[{"type":"element","tagName":"a","properties":{"href":"#how-it-works","aria-label":"how it works permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"How it works"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The mechanism is based on a lightweight protocol extension between Warthog Client and Warthog Server. It works as follows:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"When the client makes a query, it will optimistically send a short (64-byte) cryptographic hash instead of the full query text."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Optimized Path:"}]},{"type":"text","value":" If a request containing a persisted query hash is detected, Warthog Server will look it up to find a corresponding query in its registry. Upon finding a match, Warthog Server will expand the request with the full text of the query and execute it."}]},{"type":"text","value":"\n"},{"type":"raw","value":"<img src=\"/persistedQueries.optPath-98cb0f1ed777fbd3fb0d0701e41d5dee.png\" width=\"80%\" style=\"margin: 5%\" alt=\"Optimized Path\">"},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"New Query Path:"}]},{"type":"text","value":" In the unlikely event that the query is not already in the Warthog Server registry (this only happens the very first time that Warthog Server sees a query), it will ask the client to resend the request using the full text of the query. At that point Warthog Server will store the query / hash mapping in the registry for all subsequent requests to benefit from."}]},{"type":"text","value":"\n"},{"type":"raw","value":"<img src=\"/persistedQueries.newPath-d500b543a6ad2a7d64ed7f190d40bd8c.png\" width=\"80%\" style=\"margin: 5%;\" alt=\"New Query Path\">"},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"cdn-integration"},"children":[{"type":"element","tagName":"a","properties":{"href":"#cdn-integration","aria-label":"cdn integration permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"CDN Integration"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Content Delivery Networks (CDNs) such as "},{"type":"element","tagName":"a","properties":{"href":"https://fly.io"},"children":[{"type":"text","value":"fly.io"}]},{"type":"text","value":", "},{"type":"element","tagName":"a","properties":{"href":"https://www.cloudflare.com/"},"children":[{"type":"text","value":"Cloudflare"}]},{"type":"text","value":", "},{"type":"element","tagName":"a","properties":{"href":"https://www.akamai.com/"},"children":[{"type":"text","value":"Akamai"}]},{"type":"text","value":" or "},{"type":"element","tagName":"a","properties":{"href":"https://www.fastly.com/"},"children":[{"type":"text","value":"Fastly"}]},{"type":"text","value":" allow content caching close to clients, delivering data with low latency from a nearby server. Warthog Server makes it straightforward to use CDNs with GraphQL queries to cache full responses while still executing more dynamic queries."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To use Warthog Server behind a CDN, we define which GraphQL responses the CDN is allowed to cache. On the client, we set up "},{"type":"element","tagName":"a","properties":{"href":"#automatic-persisted-queries"},"children":[{"type":"text","value":"automatic persisted queries"}]},{"type":"text","value":" to ensure that GraphQL requests are in a format that a CDN can understand."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"step-1-add-cache-hints-to-the-graphql-schema"},"children":[{"type":"element","tagName":"a","properties":{"href":"#step-1-add-cache-hints-to-the-graphql-schema","aria-label":"step 1 add cache hints to the graphql schema permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"Step 1: Add cache hints to the GraphQL schema"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Add cache hints as "},{"type":"element","tagName":"a","properties":{"href":"https://www.warthog.dev/docs/warthog-server/features/caching#defining-cache-hints"},"children":[{"type":"text","value":"directives"}]},{"type":"text","value":" to GraphQL schema so that Warthog Server knows which fields and types are cacheable and for how long. For example, this schema indicates that all fields that return an "},{"type":"raw","value":"<code class=\"language-text\">Author</code>"},{"type":"text","value":" should be cached for 60 seconds, and that the "},{"type":"raw","value":"<code class=\"language-text\">posts</code>"},{"type":"text","value":" field should itself be cached for 180 seconds:"}]},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-graphql line-numbers\"><code class=\"language-graphql\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">Author</span> <span class=\"token directive function\">@cacheControl</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">maxAge</span><span class=\"token punctuation\">:</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token attr-name\">id</span><span class=\"token punctuation\">:</span> Int\n  <span class=\"token attr-name\">firstName</span><span class=\"token punctuation\">:</span> String\n  <span class=\"token attr-name\">lastName</span><span class=\"token punctuation\">:</span> String\n  <span class=\"token attr-name\">posts</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>Post<span class=\"token punctuation\">]</span> <span class=\"token directive function\">@cacheControl</span><span class=\"token punctuation\">(</span><span class=\"token attr-name\">maxAge</span><span class=\"token punctuation\">:</span> <span class=\"token number\">180</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"See "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/goldcaddy77/warthog-cache-control-js#add-cache-hints-to-your-schema"},"children":[{"type":"text","value":"the cache control documentation"}]},{"type":"text","value":" for more details, including how to specify hints dynamically inside resolvers, how to set a default "},{"type":"raw","value":"<code class=\"language-text\">maxAge</code>"},{"type":"text","value":" for all fields, and how to specify that a field should be cached for specific users only (in which case CDNs should ignore it). For example, to set a default max age other than "},{"type":"raw","value":"<code class=\"language-text\">0</code>"},{"type":"text","value":" modify the Warthog Server constructor to include "},{"type":"raw","value":"<code class=\"language-text\">cacheControl</code>"},{"type":"text","value":":"}]},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  typeDefs<span class=\"token punctuation\">,</span>\n  resolvers<span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// The max age is calculated in seconds</span>\n  cacheControl<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> defaultMaxAge<span class=\"token punctuation\">:</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"After this step, Warthog Server will serve the HTTP "},{"type":"raw","value":"<code class=\"language-text\">Cache-Control</code>"},{"type":"text","value":" header on fully cacheable responses, so that any CDN in front of Warthog Server will know which responses can be cached and for how long! A \"fully cacheable\" response contains only data with non-zero "},{"type":"raw","value":"<code class=\"language-text\">maxAge</code>"},{"type":"text","value":"; the header will refer to the minimum "},{"type":"raw","value":"<code class=\"language-text\">maxAge</code>"},{"type":"text","value":" value across the whole response, and it will be "},{"type":"raw","value":"<code class=\"language-text\">public</code>"},{"type":"text","value":" unless some of the data is tagged "},{"type":"raw","value":"<code class=\"language-text\">scope: PRIVATE</code>"},{"type":"text","value":". To observe this header, use any browser's network tab in its dev tools."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"step-2-enable-automatic-persisted-queries"},"children":[{"type":"element","tagName":"a","properties":{"href":"#step-2-enable-automatic-persisted-queries","aria-label":"step 2 enable automatic persisted queries permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"Step 2: Enable automatic persisted queries"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Often, GraphQL requests are big POST requests and most CDNs will only cache GET requests. Additionally, GET requests generally work best when the URL has a bounded size. Enabling automatic persisted queries means that short hashes are sent over the wire instead of full queries, and Warthog Client can be configured to use GET requests for those hashed queries."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To do this, update the "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"client"}]},{"type":"text","value":" code. First, add the package:"}]},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">npm install warthog-link-persisted-queries</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>"},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Then, add the persisted queries link to the Warthog Client constructor before the HTTP link:"}]},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"js\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-js line-numbers\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createPersistedQueryLink <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"warthog-link-persisted-queries\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> createHttpLink <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"warthog-link-http\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> InMemoryCache <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"warthog-cache-inmemory\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ApolloLink <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"warthog-link\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> ApolloClient <span class=\"token keyword\">from</span> <span class=\"token string\">\"warthog-client\"</span><span class=\"token punctuation\">;</span>\n\nApolloLink<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  <span class=\"token function\">createPersistedQueryLink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> useGETForHashedQueries<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">createHttpLink</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> uri<span class=\"token punctuation\">:</span> <span class=\"token string\">\"/graphql\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  cache<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InMemoryCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  link<span class=\"token punctuation\">:</span> link\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>"},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Make sure to include "},{"type":"raw","value":"<code class=\"language-text\">useGETForHashedQueries: true</code>"},{"type":"text","value":". Note that the client will still use POSTs for mutations, because it's generally best to avoid GETs for non-idempotent requests."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"If configured correctly, browser's dev tools should verify that queries are now sent as GET requests, and receive appropriate "},{"type":"raw","value":"<code class=\"language-text\">Cache-Control</code>"},{"type":"text","value":" response headers."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"step-3-set-up-a-cdn"},"children":[{"type":"element","tagName":"a","properties":{"href":"#step-3-set-up-a-cdn","aria-label":"step 3 set up a cdn permalink","class":"anchor"},"children":[{"type":"raw","value":"<svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg>"}]},{"type":"text","value":"Step 3: Set up a CDN!"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"How exactly this works depends on exactly which CDN you chose. Configure your CDN to send requests to Warthog Server. Some CDNs may need to be specially configured to honor origin Cache-Control headers; for example, here is "},{"type":"element","tagName":"a","properties":{"href":"https://learn.akamai.com/en-us/webhelp/ion/oca/GUID-57C31126-F745-4FFB-AA92-6A5AAC36A8DA.html"},"children":[{"type":"text","value":"Akamai's documentation on that setting"}]},{"type":"text","value":". If all is well, cacheable queries should now be saved by the CDN!"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Note that requests served directly by a CDN will not show up in the Engine dashboard."}]},{"type":"text","value":"\n"}]}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":168,"column":1,"offset":10102}}}}